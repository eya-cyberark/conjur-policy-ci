name: Test GitHub OIDC Token and Authenticate

on:
  workflow_dispatch:
    inputs:
      base:
        description: 'Base commit SHA or branch (e.g. main)'
        required: true
      head:
        description: 'Head commit SHA or branch (e.g. feature-branch or commit SHA)'
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  authenticate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # get full history so we can diff

      - name: Install tools
        run: |
          sudo apt-get update && sudo apt-get install -y jq curl

      - name: Request GitHub OIDC Token
        id: jwt
        run: |
          echo "üîê Requesting GitHub OIDC token..."

          resp=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}?audience=conjur")

          echo "üì¶ Raw response:"
          echo "$resp"

          jwt=$(echo "$resp" | jq -r '.value')
          if [ "$jwt" = "null" ] || [ -z "$jwt" ]; then
            echo "‚ùå Failed to get JWT"
            exit 1
          fi

          echo "‚úÖ Got JWT"
          echo "jwt_token=$jwt" >> $GITHUB_ENV

      - name: Decode JWT
        run: |
          echo "üß¨ Decoded JWT Payload:"
          echo "${{ env.jwt_token }}" | cut -d '.' -f2 | base64 --decode | jq

      - name: Authenticate to Conjur Cloud with JWT
        run: |
          echo "üîí Authenticating with Conjur Cloud"

          response=$(curl -s -w "%{http_code}" -o conjur_token.txt \
            -X POST "https://sme-andrew.secretsmgr.cyberark.cloud/api/authn-jwt/EyaGithub/conjur/authenticate" \
            -H "Accept-Encoding: base64" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "jwt=${{ env.jwt_token }}")

          status=$(tail -n1 <<< "$response")

          if [ "$status" != "200" ]; then
            echo "‚ùå Auth failed with status $status"
            echo "Response Body:"
            cat conjur_token.txt
            exit 1
          fi

          echo "‚úÖ Auth succeeded"
          token=$(cat conjur_token.txt)
          echo "conjur_token=$token" >> $GITHUB_ENV

      - name: Print Conjur Token (for debugging)
        run: |
          echo "üîë Conjur Token:"
          echo "${{ env.conjur_token }}"

      - name: Load changed Policy files to Conjur
        run: |
          echo "üìÇ Finding changed policy files between ${{ github.event.inputs.base }} and ${{ github.event.inputs.head }}"

          files=$(git diff --name-only ${{ github.event.inputs.base }} ${{ github.event.inputs.head }} -- policy/)

          echo "Changed policy files:"
          echo "$files"

          found_01=false
          found_02=false

          for file in $files; do
            if [[ "$file" == *workflows/*.yml ]]; then
              echo "Skipping workflow file: $file"
              continue
            fi

            if [[ -f "$file" ]]; then
              if [[ "$file" == *policy/*01.yml ]]; then
                found_01=true
              fi
              if [[ "$file" == *policy/*02.yml ]]; then
                found_02=true
              fi

              if [[ "$file" == *policy/*01.yml || "$file" == *policy/*02.yml ]]; then
                echo "üìÑ Uploading changed policy file: $file"
                cat "$file"

                curl -v --request POST \
                  --url https://sme-andrew.secretsmgr.cyberark.cloud/api/policies/conjur/policy/data/githubTest \
                  --header "Authorization: Token token=\"${{ env.conjur_token }}\"" \
                  --header "Content-Type: text/plain" \
                  --data-binary @"$file"
              fi
            fi
          done

          if [[ "$found_01" == true && "$found_02" == true ]]; then
            echo "‚úÖ Both 01 and 02 policy files were changed!"
          else
            echo "‚ÑπÔ∏è One or both policy files were not changed."
          fi