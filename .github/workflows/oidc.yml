name: Test GitHub OIDC Token and Authenticate

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  authenticate:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt-get update && sudo apt-get install -y jq curl

      - name: Request GitHub OIDC Token
        id: jwt
        run: |
          echo "🔐 Requesting GitHub OIDC token..."
          resp=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}?audience=conjur")
          echo "Raw: $resp"
          jwt=$(echo "$resp" | jq -r '.value')
          if [ "$jwt" = "null" ] || [ -z "$jwt" ]; then
            echo "❌ Failed to get JWT"
            exit 1
          fi
          echo "✅ Got JWT"
          echo "jwt_token=$jwt" >> $GITHUB_ENV

      - name: Base64 Encode JWT
        run: |
          jwt_b64=$(echo -n "${{ env.jwt_token }}" | base64 | tr -d '\n')
          echo "jwt_base64=$jwt_b64" >> $GITHUB_ENV
      
      - name: Decode JWT
        run: |
          echo "$jwt_token" | cut -d '.' -f2 | base64 --decode | jq


      - name: Authenticate to Conjur Cloud with JWT
        run: |
          echo "🔒 Authenticating with Conjur Cloud"
          response=$(curl -s -w "%{http_code}" -o conjur_token.txt \
            -X POST "https://sme-andrew.secretsmgr.cyberark.cloud/api/authn-jwt/EyaGithub/conjur/authenticate" \
            -H "Accept-Encoding: base64" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "jwt=${{ env.jwt_token }}")

          status=$(tail -n1 <<< "$response")
          if [ "$status" != "200" ]; then
            echo "❌ Auth failed with status $status"
            cat conjur_token.txt
            exit 1
          fi
          echo "✅ Auth succeeded"
          token=$(cat conjur_token.txt)
          echo "conjur_token=$token" >> $GITHUB_ENV
